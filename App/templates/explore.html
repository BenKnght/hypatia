{% extends "index.html" %}
{% block title %}Explore & Interact with Data{% endblock %}

{% block head %}
    {{ super() }}
    <link href="/static/bower_components/amcharts/dist/amcharts/plugins/export/export.css" media="all" rel="stylesheet"
          type="text/css"/>
    <link href="/static/bower_components/jquery-ui/themes/smoothness/jquery-ui.min.css" rel="stylesheet"/>
    <style type="text/css">
        .popover {
            max-width: 100%;
        }

        #stars td {
            border-bottom: none !important;
        }

        .position-me {
            position: absolute;
            top: 50px;
            left: 50px;
            transform: translateX(-100%);
        }

        .rotate-me {
            transform: rotate(-90deg);
            transform-origin: right top;
            text-align: center;
        }

        form {
            margin-bottom: 10px;
        }
    </style>
{% endblock %}

{% block content %}
    {% raw %}
    <div ng-app="viz">
        <base href="/"/>
        <div ng-cloak ng-controller="VisualizationController as v">

            <!--TODO: alert doesnt show the message-->
            <!--<my-alert data-msg="alert_msg" data-type="alert_type"></my-alert>-->

            <form ng-submit="filterStars($event)">

                <div class="form-group">
                    <label for="normalization">Solar Normalization</label>
                    <select id="normalization" name="normalization" class="form-control" ng-model="solarnorm"
                            ng-change="updateChart()">
                        <option value="Lodders et al. (2009)">Lodders et al. (2009)</option>
                        <option value="Anders & Grevesse (1989)">Anders & Grevesse (1989)</option>
                        <option value="Anders & Grevesse (1989), Fe = 7.47">Anders & Grevesse (1989), Fe = 7.47</option>
                        <option value="Grevesse & Sauval (1998)">Grevesse & Sauval (1998)</option>
                        <option value="Asplund et al. (2009)">Asplund et al. (2009)</option>
                    </select>
                </div>

                <input style="width: 83.333333%" type="text" class="form-control col-md-10 col-xs-10 col-sm-10"
                       id="search" placeholder="Filter criteria" ng-focus="openSuggestions()"
                       data-toggle="popover" data-placement="top" data-container="body" data-trigger="hover focus"
                       data-html="true" title="Need help? Readme" ng-model="filterText"
                       data-content="you can try any of these,<ul><li>hip = '7444'</li><li>dist > 20 and disk = 'thin'</li><li>rascension > 300 or declination < 50</li></ul>">
                <button type="submit" style="margin-left: 10px;" class="btn btn-primary col-md-1 col-xs-1 col-sm-1">
                    Filter
                </button>
                <div class="clearfix"></div>
            </form>

            <div class="panel panel-default">
                <div class="panel-body" id="chart" style="width: 100%; height: 500px;"></div>
            </div>

            <div id="controls" class="row" style="margin-bottom: 15px;">
                <div class="col-md-4">
                    <fieldset>
                        <legend>Planet Info</legend>
                        <label class="radio-inline col-md-3">
                            <input type="radio" name="planetRadios" data-toggle="tooltip" data-trigger="hover"
                                   data-placement="top" title="Only show stars which have planets"
                                   ng-click="onlyPlanets()"> Have planets</label>
                        <label class="radio-inline col-md-4">
                            <input type="radio" name="planetRadios" data-toggle="tooltip" data-placement="top"
                                   title="Only show stars which do not have planets" data-trigger="hover"
                                   ng-click="exceptPlanets()"> Do not have planets</label>
                        <label class="radio-inline col-md-3">
                            <input type="radio" name="planetRadios" data-toggle="tooltip" data-placement="top"
                                   title="Show stars regardless whether they have planets or not" data-trigger="hover"
                                   ng-click="regardlessOfPlanets()" checked> Show all</label>
                    </fieldset>
                </div>
                <div class="col-md-2">
                    <fieldset>
                        <legend>Star's Abundance Info</legend>
                        <label class="checkbox-inline">
                            <input type="checkbox" data-toggle="tooltip" data-placement="top" data-trigger="hover"
                                   ng-click="toggleElements()" ng-model="showElements"
                                   title="Show elements for each star"> Show
                            elements</label>
                    </fieldset>
                </div>
                <div class="col-md-6">
                    <fieldset>
                        <legend>Chart Controls</legend>
                        <form class="form-inline">
                            <div class="form-group" style="margin-right: 15px; vertical-align: top;">
                                <label for="xaxis">X-Axis</label>
                                <select id="xaxis" ng-model="xaxis" class="form-control" ng-change="updateChart()">
                                    <option ng-repeat="(e, v) in elements" value="{{e}}">{{v}}</option>
                                </select>
                            </div>
                            <div class="form-group" style="vertical-align: top;">
                                <label for="yaxis">Y-Axis</label>
                                <select id="yaxis" ng-model="yaxis" class="form-control" ng-change="updateChart()">
                                    <option ng-repeat="(e, v) in elements" value="{{e}}">{{v}}</option>
                                </select>
                            </div>
                            <div class="form-group col-md-offset-1">
                                <label for="excat" style="vertical-align: top">Exclude Catalogs</label>
                                <select id="excat" multiple class="form-control" ng-change="updateChart()"
                                        ng-model="excluded_cat">
                                    <option ng-repeat="c in catalogs" value="{{c}}">{{c}}</option>
                                </select>
                            </div>

                            <div class="clearfix"></div>
                        </form>
                    </fieldset>
                </div>
            </div>

            <div class="table-responsive">
                <table id="stars" class="table table-condensed table-bordered table-striped"
                       style="border-collapse: collapse">
                    <thead>
                    <tr>
                        <th colspan="{{ columns.length }}">Showing {{cStars()}} stars</th>
                    </tr>
                    <tr>
                        <th ng-repeat="c in columns">{{c}}</th>
                    </tr>
                    </thead>
                    <tr ng-repeat-start="(hip, star) in stars">
                        <td ng-repeat="c in columns">{{ star[c] }}</td>
                    </tr>
                    <tr ng-repeat-end ng-if="star['planets'] || (star['elements'] && showElements)">
                        <td colspan="{{ columns.length }}" style="border:none; position: relative;">
                            <div class="row">
                                <div class="col-md-4" style="max-height: 115px; overflow-y: scroll">
                                    <!--<div class="position-me">
                                        <div class="rotate-me">
                                            <p>PLANETS</p>
                                        </div>
                                    </div>-->
                                    <div class="col-md-6" ng-repeat="p in star['planets']">
                                        <h4 class="media-heading">[{{ p['name'] }}]</h4>
                                        <ul class="list-unstyled">
                                            <li><strong>p: </strong>{{ p['p'] }}</li>
                                            <li><strong>e: </strong>{{ p['e'] }}</li>
                                            <li><strong>a: </strong>{{ p['a'] }}</li>
                                            <li><strong>m_p: </strong>{{ p['m_p'] }}</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-7" style="max-height: 115px; overflow-y: scroll"
                                     ng-show="showElements">
                                    <div class="col-xs-6 col-md-3" ng-repeat="p in star['elements']">
                                        <h5 class="media-heading">{{ p['element'] }}
                                            <small>{{ p['catalogue'] }}</small>
                                        </h5>
                                        <p>{{ p['value'] }}</p>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    {% endraw %}
    <script type="text/javascript" src="/static/bower_components/angular/angular.min.js"></script>
    <script type="text/javascript" src="/static/bower_components/angular-sanitize/angular-sanitize.min.js"></script>
    <script type="text/javascript" src="/static/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/static/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/bower_components/amcharts/dist/amcharts/amcharts.js"></script>
    <script type="text/javascript" src="/static/bower_components/amcharts/dist/amcharts/xy.js"></script>
    <script type="text/javascript"
            src="/static/bower_components/amcharts/dist/amcharts/plugins/export/export.min.js"></script>

    <script type="text/javascript" src="/static/bower_components/jquery-ui/ui/core.js"></script>
    <script type="text/javascript" src="/static/bower_components/jquery-ui/ui/widget.js"></script>
    <script type="text/javascript" src="/static/bower_components/jquery-ui/ui/position.js"></script>
    <script type="text/javascript" src="/static/bower_components/jquery-ui/ui/menu.js"></script>
    <script type="text/javascript" src="/static/bower_components/jquery-ui/ui/autocomplete.js"></script>

    <script type="text/javascript" src="/static/js/StateMachine.js"></script>

    <script type="text/javascript">
        (function (angular, $, AmCharts) {
            const app = angular.module('viz', ['ngSanitize']).config(['$locationProvider',
                function ($locationProvider) {
                    $locationProvider.html5Mode(true);
                }]);

            function setAlertMsg(data, $scope, type='info') {
                if (data['status']) {
                    $scope.alert_type = type;
                    $scope.alert_msg = data['status']['message'];
                }
            }

            app.controller('VisualizationController', function ($scope, $location, StarService, PlotService, $q, PlanetService) {

                $scope.columns = ['hip', 'hd', 'hr', 'spec', 'vmag', 'bv', 'dist', 'rascension', 'declination',
                    'position', 'disk', 'uvw', 'teff', 'logg', 'mass', 'vsini']; // 'multiple_planets'
                $scope.elements = {
                    'YH': 'Y/H',
                    'NiH': 'Ni/H',
                    'KH': 'K/H',
                    'LaH': 'La/H',
                    'MgH': 'Mg/H',
                    'RuH': 'Ru/H',
                    'CeH': 'Ce/H',
                    'CaIIH': 'CaII/H',
                    'DyH': 'Dy/H',
                    'MoH': 'Mo/H',
                    'LaIIH': 'LaII/H',
                    'NH': 'N/H',
                    'EuH': 'Eu/H',
                    'NaH': 'Na/H',
                    'CeIIH': 'CeII/H',
                    'LiH': 'Li/H',
                    'NdIIH': 'NdII/H',
                    'FeH': 'Fe/H',
                    'SH': 'S/H',
                    'TiH': 'Ti/H',
                    'SmH': 'Sm/H',
                    'EuIIH': 'EuII/H',
                    'BaIIH': 'BaII/H',
                    'SiH': 'Si/H',
                    'ZrH': 'Zr/H',
                    'CH': 'C/H',
                    'ScH': 'Sc/H',
                    'AlH': 'Al/H',
                    'YIIH': 'YII/H',
                    'VH': 'V/H',
                    'PdH': 'Pd/H',
                    'TiIIH': 'TiII/H',
                    'PrH': 'Pr/H',
                    'MnH': 'Mn/H',
                    'GdH': 'Gd/H',
                    'ScIIH': 'ScII/H',
                    'SmIIH': 'SmII/H',
                    'PH': 'P/H',
                    'SrIIH': 'SrII/H',
                    'AgH': 'Ag/H',
                    'NdH': 'Nd/H',
                    'BeH': 'Be/H',
                    'OH': 'O/H',
                    'SrH': 'Sr/H',
                    'ZnH': 'Zn/H',
                    'CrIIH': 'CrII/H',
                    'HfH': 'Hf/H',
                    'CaH': 'Ca/H',
                    'VIIH': 'VII/H',
                    'ZrIIH': 'ZrII/H',
                    'CoH': 'Co/H',
                    'CrH': 'Cr/H',
                    'CuH': 'Cu/H',
                    'PbH': 'Pb/H',
                    'BaH': 'Ba/H'
                };
                $scope.catalogs = ["Adamow et al. (2014)", "Adibekyan et al. (2012)", "Adibekyan et al. (2015)", "Allen & Porto de Mello (2011)", "Allende Prieto et al. (2004)", "Battistini et al. 2015", "Bensby et al. (2005)", "Bensby et al. 2014", "Bergemann et al. (2010)", "Bertran de Lis et al. (2015)", "Biazzo et al. (2012)", "Bodaghee et al. (2003)", "Boesgaard et al. (2011)", "Bond et al. (2006, 2008)", "Brewer & Carney (2006)", "Brugamyer et al. (2011)", "Bruntt et al. (2012)", "Caffau et al. (2011)", "Carretta et al. (2000)", "Castro et al. (1997)", "Castro et al. (1999)", "Chen et al. (2000)", "D'Orazi et al. (2012)", "da Silva et al. (2012)", "Delgado Mena et al. (2010)", "Ecuvillon et al. (2004)", "Ecuvillon et al. (2006)", "Edvardsson et al. (1993)", "Feltzing & Gustafsson (1998)", "Feltzing et al. (2007)", "Francois (1986)", "Francois (1988)", "Fulbright (2000)", "Galeev et al. (2004)", "Gebran et al. (2010)", "Gehren et al. (2004)", "Gehren et al. (2006)", "Gilli et al. (2006)", "Gonzalez & Laws (2007)", "Gonzalez et al. (2001)", "Gonzalez Hernandez et al. (2010)", "Gonzalez Hernandez et al. (2013)", "Gratton et al. (2000)", "Gratton et al. (2003)", "Gustafsson et al. (1999)", "Huang et al. (2005)", "Ishigaki et al. (2012)", "Ishigaki et al. (2013)", "Jofre et al. (2015)", "Jonsell et al. (2005)", "Kang et al. (2011)", "Karinkuzhi et al. (2014)", "Koch & Edvardsson (2002)", "Korotin et al. (2011)", "Laird (1985)", "Liu et al. (2012)", "Luck & Heiter (2005)", "Maldonado et al. (2013)", "Mann et al. 2013", "Mashonkina et al. (2006)", "Mashonkina et al. (2007)", "Mishenina et al. (2003)", "Mishenina et al. (2004)", "Mishenina et al. (2008)", "Mishenina et al. (2011)", "Mishenina et al. (2013)", "Mishenina et al. (2015)", "Mortier et al. (2013)", "Neuforge-Verheecke & Magain (1997)", "Neves et al. (2009)", "Nissen & Schuster (1997)", "Nissen & Schuster (2010)", "Nissen et al. (2011)", "Nissen et al. (2014)", "Nissen et al. (2015)", "Peterson et al. (2013)", "Petigura & Marcy (2011)", "Porto de Mello et al. (2008)", "Ramirez et al. (2007)", "Ramirez et al. (2009)", "Ramirez et al. (2012)", "Ramirez et al. (2014a)", "Ramirez et al. (2014b)", "Recio Blanco et al. (2012)", "Reddy et al. (2003)", "Reddy et al. (2006)", "Sadakane et al. (2002)", "Schuler et al. (2011)", "Shi et al. (2004)", "Shi et al. (2012)", "Sitnova et al. (2015)", "Stonkute et al. (2012)", "Stonkute et al. (2013)", "Takeda (2007), Takeda & Honda (2005)", "Takeda et al. (2005)", "Thevenin (1998)", "Trevisan et al. (2011)", "Valenti & Fischer (2005)", "Wang et al. (2011)", "Wu et al. (2015)", "Yan et al. (2015)", "Zenovience et al. (2014)", "Zhang & Zhao (2006)", "Zhao et al. (2002)"];
                $scope.stars = {};
                $scope.noPlanets = false; // flag to indicate whether to retrieve planet info
                $scope.showElements = false;
                $scope.xaxis = 'FeH';
                $scope.yaxis = 'AlH';
                $scope.solarnorm = 'Lodders et al. (2009)';
                // TODO: Update URL to make it sharable
                // $location.search({"search": "hip>100"});

                let pageNumber = 0, pageSize = 25;

                function fetchStars() {
                    let deferred = $q.defer();
                    StarService.stars(pageNumber, pageSize, $scope.filterText).then(function (data) {
                        if (Object.keys(data['stars']).length < pageSize)
                            deferred.reject(); // fetched all stars
                        angular.extend($scope.stars, data['stars']);
                        setAlertMsg(data, $scope, 'success');
                        $scope.updateChart();
                        if ($scope.showElements)
                            fetchElements();
                        if (!$scope.noPlanets)
                            fetchPlanets();
                        deferred.resolve();
                    }, function (err) {
                        setAlertMsg(err, $scope, 'danger');
                        deferred.reject();
                    });
                    return deferred.promise;
                }

                $scope.cStars = function () {
                    return Object.keys($scope.stars).length;
                };

                $scope.filterStars = function (e) {
                    e.preventDefault();
                    return invokeFilters();
                };
                function initPage() {
                    fetchStars().then(function () {
                        pageNumber++;
                        // Keep loading more stars until the user's screen is full
                        if ($(document).height() < $(window).height())
                            initPage();
                    });

                }

                initPage();

                $(window).scroll(function () {
                    // Pre-fetch the stars before user hits the bottom to get a smooth user experience
                    // 120 is arrived assuming user takes 0.5s to scroll one a screen of 1000px long and
                    // network i/o = 60ms,
                    if ($(window).scrollTop() == $(document).height() - $(window).height()) {
                        pageNumber++;
                        fetchStars();
                    }
                });

                $scope.updateChart = function () {
                    let hips = Object.keys($scope.stars);
                    PlotService.scatter($scope.solarnorm, hips, [$scope.xaxis, $scope.yaxis], $scope.excluded_cat).then(function (data) {
                        /**
                         * Sample data:
                         * stars: {
                                    7444: {
                                        AlH: -0.029999999329447746,
                                        CaH: -0.10999999940395355,
                                        FeH: -0.17000000178813934,
                                        MgH: 0.10000000149011612,
                                        OH: 0.07000000029802322,
                                        TiH: 0.20999999344348907
                                    },
                               }
                         */
                        $scope.chart.dataProvider = [];
                        let xlabel = `[${$scope.elements[$scope.xaxis]}]`;
                        let ylabel = `[${$scope.elements[$scope.yaxis]}]`;
                        for (let star in data['stars']) {
                            let composition = data['stars'][star];
                            try {
                                $scope.chart.dataProvider.push({
                                    x: composition[$scope.xaxis],
                                    y: composition[$scope.yaxis],
                                    value: `Star: ${star}<br />${xlabel}: ${composition[$scope.xaxis]}<br />${ylabel}: ${composition[$scope.yaxis]}`
                                });
                            }
                            catch (err) {
                                console.log(`For star, ${star}. Error: ${err}`);
                            }
                        }

                        $scope.chart.valueAxes[0].title = xlabel;
                        $scope.chart.valueAxes[1].title = ylabel;
                        $scope.chart.validateData();
                    });
                };

                function fetchPlanets() {
                    let hips = Object.keys($scope.stars);
                    PlanetService.planets(hips).then(function (data) {
                        /**
                         * Sample data:
                         * {
                         *      hip1: [{planet1_obj}, {planet2_obj}, {planet3_obj},...]
                         *      hip2: [{planet1_obj}, {planet2_obj}, {planet3_obj},...]
                         * }
                         */
                        for (let hip in data['planets']) {
                            $scope.stars[hip]['planets'] = data['planets'][hip];
                        }
                    });
                }

                function fetchElements() {
                    let hips = Object.keys($scope.stars);
                    StarService.elements(hips).then(function (data) {
                        /**
                         * Sample data:
                         * {
                         *      hip1: [{elem1_obj}, {elem2_obj}, {elem3_obj},...]
                         *      hip2: [{elem1_obj}, {elem2_obj}, {elem3_obj},...]
                         * }
                         */
                        for (let hip in data['elements']) {
                            $scope.stars[hip]['elements'] = data['elements'][hip];
                        }
                    });
                }

                // Filters
                $scope.onlyPlanets = function () {
                    $scope.noPlanets = false;
                    $scope.filterText = 'multiple_planets > 0';
                    invokeFilters();
                };
                $scope.exceptPlanets = function () {
                    $scope.noPlanets = true;
                    $scope.filterText = 'multiple_planets = 0';
                    invokeFilters();
                };
                $scope.regardlessOfPlanets = function () {
                    $scope.noPlanets = false;
                    $scope.filterText = '';
                    invokeFilters();
                };
                $scope.toggleElements = function () {
                    if ($scope.showElements) {
                        fetchElements();
                    }
                };
                function invokeFilters() {
                    pageNumber = 0; // reset page
                    $scope.stars = {}; // clear stars to make way for new set
                    return fetchStars();
                }

                // Charting
                $scope.chart = AmCharts.makeChart("chart", {
                    "type": "xy",
                    "autoMargins": true,
                    "autoMarginOffset": 20,
                    "handDrawn": false,
                    "addClassNames": false,
                    "graphs": [
                        {
                            "bullet": "round",
                            "bulletSize": 10,
                            "lineAlpha": 0,
                            "valueField": "value",
                            "xField": "x",
                            "yField": "y"
                        }
                    ],
                    'valueAxes': [{
                        "position": "bottom",
                        "axisAlpha": 0,
                        "dashLength": 1
                    }, {
                        "axisAlpha": 0,
                        "dashLength": 1,
                        "position": "left"
                    }],
                    "dataProvider": [],
                    "export": {
                        "enabled": true
                    }
                });

                // Filter Textbox
//            let start = new State($scope.columns);
//            let filterExpr = new StateMachine(start); // key
//            filterExpr.next(new State(['>', '<', '=', '<=', '>='])); // operator
//            filterExpr.next(new State([], true)); // values
//            filterExpr.next(new State(['AND', 'OR'])); // combiner
//            filterExpr.next(start);
//            window.myState = filterExpr;
//            let filterTokens = [], states = [];
//
//            function suggest(request, response) {
//                // console.log(filterExpr.current.values);
//                response(filterExpr.current.values);
//            }
//
//            function moveToNextState(newItem) {
//                filterTokens.push(newItem);
//                this.value = filterTokens.join(" ") + " ";
//                states.push(filterExpr.current); // TODO: handle when user starting modifying existing expression
//                filterExpr.next(); // move to next state
//                $scope.openSuggestions();
//            }
//
//            function getTokens(filterText) {
//                // tokens are separated by a space
//                return filterText.split(/\s+/);
//            }
//
//            function selected(event, ui) {
//                moveToNextState.call(this, ui.item.value.trim());
//                return false; // prevent default behavior of replacing the entire input field's value
//            }
//
//            $scope.openSuggestions = function () {
//                $("#search").autocomplete("search"); // open suggestions
//            };
//            $("#search").bind('keypress', function (event) {
//                if (event.keyCode === $.ui.keyCode.SPACE) {
//                    // Move to next state
//                    moveToNextState.call(this, getTokens(this.value.trim()).pop());
//                    event.preventDefault();
//                }
//            }).autocomplete({
//                source: suggest,
//                select: selected, minLength: 0,
//                focus: function () {
//                    return false;
//                }
//            });
//
//            $("#search").autocomplete("disable"); // TODO: disabled until entire control is ready
            });

            app.directive('myAlert', function () {
                return {
                    restrict: 'E',
                    scope: {
                        msg: '=',
                        type: '='
                    },
                    templateUrl: '/partials/_my-alert.html'
                }
            });

            app.factory('StarService', function ($http, $q) {
                return {
                    "stars": function (pageNumber, pageSize, query=null) {
                        let deferred = $q.defer();
                        $http.get(`/stars/${pageNumber}/${pageSize}`, {params: {'query': query}}).success(function (data) {
                            deferred.resolve(data);
                        }).error(function (err) {
                            deferred.reject(err);
                        });
                        return deferred.promise;
                    },
                    "elements": function (stars=[]) {
                        let deferred = $q.defer();
                        $http.post('/elements/', {stars: stars}).success(function (data) {
                            deferred.resolve(data);
                        }).error(function (err) {
                            deferred.reject(err);
                        });
                        return deferred.promise;
                    }
                }
            });

            app.factory('PlanetService', function ($http, $q) {
                return {
                    "planets": function (stars=[]) {
                        let deferred = $q.defer();
                        $http.post('/planets/', {stars: stars}).success(function (data) {
                            deferred.resolve(data);
                        }).error(function (err) {
                            deferred.reject(err);
                        });
                        return deferred.promise;
                    }
                }
            });

            app.factory('PlotService', function ($http, $q) {
                return {
                    "scatter": function (solarnorm, stars=[], elements=[], catalogs=[]) {
                        let deferred = $q.defer();
                        let data = {
                            'normalization': solarnorm,
                            'stars': stars,
                            'elements': elements,
                            'catalogs': catalogs
                        };
                        $http.post(`/plots/composition/`, data).success(function (data) {
                            deferred.resolve(data);
                        }).error(function (err) {
                            deferred.reject(err);
                        });
                        return deferred.promise;
                    }
                }
            });

            // JQuery
            $("#search").popover();
            $('[data-toggle="tooltip"]').tooltip();


        })(window.angular, window.$, window.AmCharts);
    </script>
{% endblock %}