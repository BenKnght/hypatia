{% extends "index.html" %}
{% block title %}Explore & Interact with Data{% endblock %}

{% block head %}
    {{ super() }}
    <link href="/static/bower_components/amcharts/dist/amcharts/plugins/export/export.css" media="all" rel="stylesheet"
          type="text/css"/>
    <link href="/static/bower_components/jquery-ui/themes/smoothness/jquery-ui.min.css" rel="stylesheet"/>
    <style type="text/css">
        .popover {
            max-width: 100%;
        }

        #stars td {
            border-bottom: none !important;
        }

        .position-me {
            position: absolute;
            top: 50px;
            left: 50px;
            transform: translateX(-100%);
        }

        .rotate-me {
            transform: rotate(-90deg);
            transform-origin: right top;
            text-align: center;
        }

        form {
            margin-bottom: 10px;
        }

        .radio {
            margin-top: 0;
        }
    </style>
{% endblock %}

{% block content %}
    {% raw %}
    <div ng-app="viz">
        <base href="/"/>
        <div ng-cloak ng-controller="VisualizationController as v">

            <!--TODO: alert doesnt show the message-->
            <!--<my-alert data-msg="alert_msg" data-type="alert_type"></my-alert>-->

            <form ng-submit="filterStars($event)">

                <div class="form-group">
                    <label for="normalization">Solar Normalization</label>
                    <select id="normalization" name="normalization" class="form-control" ng-model="solarnorm"
                            ng-change="updateChart()">
                        <option value="Lodders et al. (2009)">Lodders et al. (2009)</option>
                        <option value="Anders & Grevesse (1989)">Anders & Grevesse (1989)</option>
                        <option value="Anders & Grevesse (1989), Fe = 7.47">Anders & Grevesse (1989), Fe = 7.47</option>
                        <option value="Grevesse & Sauval (1998)">Grevesse & Sauval (1998)</option>
                        <option value="Asplund et al. (2009)">Asplund et al. (2009)</option>
                    </select>
                </div>

                <input style="width: 81.67%" type="text" class="form-control col-md-9 col-xs-9 col-sm-9"
                       id="search" placeholder="Filter criteria"
                       data-toggle="popover" data-placement="top" data-container="body" data-trigger="hover focus"
                       data-html="true" title="Need help? Readme" ng-model="filterText"
                       data-content="you can try any of these,<ul><li>hip = '7444'</li><li>dist > 20 and disk = 'thin'</li><li>rascension > 300 or declination < 50</li></ul>">
                <button type="submit" style="margin-left: 10px;" class="btn btn-primary col-md-1 col-xs-1 col-sm-1">
                    Filter
                </button>
                <button ng-show="renderTable" ng-click="renderTable = false" type="button" style="margin-left: 10px;"
                        class="btn btn-primary col-md-1 col-xs-1 col-sm-1">
                    Hide Table
                </button>
                <button ng-hide="renderTable" ng-click="renderTable = true" type="button" style="margin-left: 10px;"
                        class="btn btn-primary col-md-1 col-xs-1 col-sm-1">
                    Show Table
                </button>
                <div class="clearfix"></div>
            </form>

            <!-- Nav tabs -->
            <ul class="nav nav-tabs">
                <li role="presentation" ng-class="{active: activeChart == 1}">
                    <a href="#" ng-click="activeChart = 1; updateChart()">X/Y vs X/Y</a>
                </li>
                <li role="presentation" ng-class="{active: activeChart == 2}">
                    <a href="#" ng-click="activeChart = 2; updateChart()">Stellar</a>
                </li>
                <li role="presentation" ng-class="{active: activeChart == 3}">
                    <a href="#" ng-click="activeChart = 3; updateChart()">Stars & their Planets</a>
                </li>
                <li role="presentation" ng-class="{active: activeChart == 4}">
                    <a href="#" ng-click="activeChart = 4; updateChart()">Planet hosts vs non-hosts</a>
                </li>
                <!--<li role="presentation" ng-class="{active: activeChart == 5}">
                    <a href="#" ng-click="activeChart = 5; updateChart()">Chart 5</a>
                </li>-->
            </ul>

            <div class="row">
                <div class="panel-body col-md-10" id="chart" style="height: 500px;"></div>
                <div class="panel-body col-md-2">
                    <div id="legend"></div>
                    <div class="form-inline" style="margin-left: 50px;" ng-hide="activeChart === 4">
                        <select class="form-control" ng-model="zaxis_num" ng-change="updateZ()">
                            <option ng-repeat="(e, v) in elements" value="{{e}}">{{v}}</option>
                        </select> /
                        <select class="form-control" ng-model="zaxis_den" ng-change="updateZ()">
                            <option ng-repeat="(e, v) in elements" value="{{e}}">{{v}}</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="controls" class="row" style="margin-bottom: 15px;">
                <div class="col-md-2">
                    <fieldset>
                        <legend>Planet Info</legend>
                        <div class="radio">
                            <label>
                                <input type="radio" name="planetRadios" data-toggle="tooltip" data-trigger="hover"
                                       data-placement="top" title="Only show stars which have planets"
                                       ng-click="onlyPlanets()"> Have planets</label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="planetRadios" data-toggle="tooltip" data-placement="top"
                                       title="Only show stars which do not have planets" data-trigger="hover"
                                       ng-click="exceptPlanets()"> Do not have planets</label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="planetRadios" data-toggle="tooltip" data-placement="top"
                                       title="Show stars regardless whether they have planets or not"
                                       data-trigger="hover"
                                       ng-click="regardlessOfPlanets()" checked> Show all</label>
                        </div>
                    </fieldset>
                </div>
                <div class="col-md-2">
                    <fieldset>
                        <legend>Star's Abundance Info</legend>
                        <label class="checkbox-inline">
                            <input type="checkbox" data-toggle="tooltip" data-placement="top" data-trigger="hover"
                                   ng-click="toggleElements()" ng-model="showElements"
                                   title="Show elements for each star"> Show
                            elements</label>
                    </fieldset>
                </div>
                <div class="col-md-8">
                    <fieldset>
                        <legend>Chart Controls</legend>
                        <div class="col-md-4">
                            <div class="form-inline">
                                <div class="form-group">
                                    <label>X-Axis</label>

                                    <div ng-show="activeChart == 1">
                                        <select ng-model="xaxis_num" class="form-control" ng-change="updateChart()">
                                            <option ng-repeat="(e, v) in elements" value="{{e}}">{{v}}</option>
                                        </select> /
                                        <select class="form-control" ng-model="xaxis_den" ng-change="updateChart()">
                                            <option ng-repeat="(e, v) in elements" value="{{e}}">{{v}}</option>
                                        </select>
                                    </div>

                                    <div ng-show="activeChart == 2">
                                        <select ng-model="c2_xaxis" class="form-control" ng-change="updateChart()">
                                            <option value="dist">Distance</option>
                                            <option value="v">V</option>
                                        </select>
                                    </div>

                                    <div ng-show="activeChart == 3">
                                        <select ng-model="c3_xaxis" class="form-control" ng-change="updateChart()">
                                            <option value="pmass">Planet Mass</option>
                                            <option value="e">Eccentricity</option>
                                            <option value="smass">Stellar Mass</option>
                                        </select>
                                    </div>

                                    <div ng-show="activeChart == 4">
                                        <select ng-model="c4_xaxis_num" class="form-control" ng-change="updateChart()">
                                            <option ng-repeat="(e, v) in elements" value="{{e}}">{{v}}</option>
                                        </select> /
                                        <select class="form-control" ng-model="c4_xaxis_den" ng-change="updateChart()">
                                            <option ng-repeat="(e, v) in elements" value="{{e}}">{{v}}</option>
                                        </select>
                                    </div>

                                    <div ng-show="activeChart == 5"></div>
                                </div>
                            </div>

                            <div class="form-inline" style="margin-top: 10px;">
                                <div class="form-group">
                                    <label>Y-Axis</label>

                                    <div ng-show="activeChart == 1">
                                        <select ng-model="yaxis_num" class="form-control" ng-change="updateChart()">
                                            <option ng-repeat="(e, v) in elements" value="{{e}}">{{v}}</option>
                                        </select> /
                                        <select class="form-control" ng-model="yaxis_den" ng-change="updateChart()">
                                            <option ng-repeat="(e, v) in elements" value="{{e}}">{{v}}</option>
                                        </select>
                                    </div>

                                    <div ng-show="activeChart == 2">
                                        <select ng-model="c2_yaxis" class="form-control" ng-change="updateChart()">
                                            <option value="uwsq">SQRT(u^2 + w^2)</option>
                                        </select>
                                    </div>

                                    <div ng-show="activeChart == 3">
                                        <select ng-model="c3_yaxis" class="form-control" ng-change="updateChart()">
                                            <option value="period">Period</option>
                                            <option value="sma">SMA</option>
                                            <option value="pmass">Planet mass</option>
                                            <option value="e">Eccentricity</option>
                                        </select>
                                    </div>

                                    <div ng-show="activeChart == 4">
                                        <select ng-model="c4_yaxis" class="form-control" ng-change="updateChart()">
                                            <option value="rfreq">Relative Frequency</option>
                                        </select>
                                    </div>

                                    <div ng-show="activeChart == 5"></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label>Aggregation type</label>
                            <div class="radio">
                                <label>
                                    <input type="radio" name="aggRadios" data-toggle="tooltip"
                                           data-trigger="hover"
                                           data-placement="top" title="Use Median Aggregation" ng-model="agg"
                                           ng-click="updateChart()" value="median"> Median</label>
                            </div>
                            <div class="radio">
                                <label>
                                    <input type="radio" name="aggRadios" data-toggle="tooltip"
                                           data-placement="top"
                                           title="Use Mean Aggregation" data-trigger="hover" ng-model="agg"
                                           ng-click="updateChart()" value="mean"> Mean</label>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="excat" style="vertical-align: top">Exclude Catalogs</label>
                            <select id="excat" multiple class="form-control" ng-change="updateChart()"
                                    ng-model="excluded_cat">
                                <option ng-repeat="c in catalogs" value="{{c}}">{{c}}</option>
                            </select>
                        </div>
                    </fieldset>
                </div>
            </div>

            <div class="table-responsive">
                <table id="stars" class="table table-condensed table-bordered table-striped"
                       style="border-collapse: collapse" ng-if="renderTable">
                    <thead>
                    <tr>
                        <th colspan="{{ columns.length }}">Showing {{cStars()}} stars</th>
                    </tr>
                    <tr>
                        <th ng-repeat="c in columns_meta" title='{{ c[1] }}'>{{c[0]}}</th>
                    </tr>
                    <tr>
                        <th ng-repeat="c in columns" title="Key to use in the filter textbox above"
                            style="font-weight: 400; text-align: center; font-style: italic; font-size: 14px">
                            {{c}}
                        </th>
                    </tr>
                    </thead>
                    <tr ng-repeat-start="(hip, star) in stars">
                        <td ng-repeat="c in columns">{{ star[c] }}</td>
                    </tr>
                    <tr ng-if="star['planets']" ng-repeat="p in star['planets']">
                        <td ng-repeat="i in [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]"></td>
                        <!-- Empty cols for star info -->
                        <td>{{ p['name'] }}</td>
                        <td>{{ parseFloat(p['p']) }}</td>
                        <td>{{ parseFloat(p['e']) }}</td>
                        <td>{{ parseFloat(p['a']) }}</td>
                        <td>{{ parseFloat(p['m_p']) }}</td>
                        <td ng-repeat="i in [0,1,2,3]"></td> <!-- Empty cols for star info -->
                    </tr>
                    <tr ng-repeat-end ng-if="star['elements'] && showElements">
                        <td colspan="{{ columns.length }}" style="border:none; position: relative;">
                            <div class="row">
                                <div class="col-md-12" style="max-height: 115px; overflow-y: scroll"
                                     ng-show="showElements">
                                    <div class="col-xs-6 col-md-3" ng-repeat="p in star['elements']">
                                        <h5 class="media-heading">{{ p['element'] }}
                                            <small>{{ p['catalogue'] }}</small>
                                        </h5>
                                        <p>{{ p['value'] }}</p>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>

                </table>
            </div>
        </div>
    </div>
    {% endraw %}
    <script type="text/javascript" src="/static/bower_components/angular/angular.min.js"></script>
    <script type="text/javascript" src="/static/bower_components/angular-sanitize/angular-sanitize.min.js"></script>
    <script type="text/javascript" src="/static/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/static/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/bower_components/amcharts/dist/amcharts/amcharts.js"></script>
    <script type="text/javascript" src="/static/bower_components/amcharts/dist/amcharts/xy.js"></script>
    <script type="text/javascript" src="/static/bower_components/amcharts/dist/amcharts/serial.js"></script>
    <script type="text/javascript"
            src="/static/bower_components/amcharts/dist/amcharts/plugins/export/export.min.js"></script>

    <script type="text/javascript" src="/static/bower_components/jquery-ui/ui/core.js"></script>
    <script type="text/javascript" src="/static/bower_components/jquery-ui/ui/widget.js"></script>
    <script type="text/javascript" src="/static/bower_components/jquery-ui/ui/position.js"></script>
    <script type="text/javascript" src="/static/bower_components/jquery-ui/ui/menu.js"></script>
    <script type="text/javascript" src="/static/bower_components/jquery-ui/ui/autocomplete.js"></script>

    <script type="text/javascript" src="/static/js/StateMachine.js"></script>

    <script type="text/javascript">
        (function (angular, $, AmCharts) {
            const app = angular.module('viz', ['ngSanitize']).config(['$locationProvider',
                function ($locationProvider) {
                    $locationProvider.html5Mode(true);
                }]);

            function setAlertMsg(data, $scope, type='info') {
                if (data['status']) {
                    $scope.alert_type = type;
                    $scope.alert_msg = data['status']['message'];
                }
            }

            app.controller('VisualizationController', function ($scope, $location, StarService, PlotService, $q, PlanetService) {

                $scope.columns = ['hip', 'hd', 'bd', 'RA', 'Dec', 'x', 'y', 'z', 'dist',
                    'disk', 'spec', 'vmag', 'bv', 'u', 'v', 'w', 'planet', 'p', 'm_p', 'e', 'a', 'teff', 'logg', 'mass', 'vsini']; // 'hr', 'multiple_planets'
                $scope.columns_meta = [['HIP', 'Hipparcos Catalog identifier'], ['HD', 'Henry Draper Catalogue identifier'], ['BD', 'Bonner Durchmusterung identifier'], ['RA', 'right ascension, Epoch=J2000 from Hipparcos'], ['Dec', 'Declination, Epoch=J2000 from Hipparcos'], ['X', 'x position in pc (dist*cos(dec)*cos(ra))'], ['Y', 'y position in pc (dist*cos(dec)*sin(ra))'], ['Z ', 'z position in pc (dist*sin(dec))'], ['dist', 'distance from the Sun in pc'], ['disk', 'thin or thick based on the kinematic prescription in Bensby et al. 2003) '], ['Spec Type', 'spectral type from Hipparcos'], ['V', 'V magnitude from Hipparcos'], ['B-V', 'Johnson color from Hipparcos'], ['u', 'galactic space velocity in km/s, to/from the direction of the Galactic center'], ['v', 'galactic space velocity in km/s, galactic rotation'], ['w', 'galactic space velocity in km/s, to/from the North Galactic Pole'], ['Planet', 'letter designation for the planet'], ['p', 'planetary period in days from exoplanets.org'], ['M_p', 'planetary mass m*sin(i) in Jupiter masses from exoplanets.org'], ['e', 'planetary eccentricity from exoplanets.org'], ['a', 'planetary semi-major axis in AU from exoplanets.org'], ['T_eff', 'stellar effective temperature in Kelvin from exoplanets.org'], ['log(g)', 'stellar surface gravity from exoplanets.org'], ['M_s', 'stellar mass from exoplanets.org'], ['v*sin(i)', 'equatorial velocity of the star in km/s from exoplanets.org)']];
                $scope.elements = {
                    'H':'H',
                    'LiH':'Li',
                    'BeH':'Be',
                    'CH':'C',
                    'NH':'N',
                    'OH':'O',
                    'NaH':'Na',
                    'MgH':'Mg',
                    'AlH':'Al',
                    'SiH':'Si',
                    'PH':'P',
                    'SH':'S',
                    'KH':'K',
                    'CaH':'Ca',
                    'CaIIH':'CaII',
                    'ScH':'Sc',
                    'ScIIH':'ScII',
                    'TiH':'Ti',
                    'TiIIH':'TiII',
                    'VH':'V',
                    'VIIH':'VII',
                    'CrH':'Cr',
                    'CrIIH':'CrII',
                    'MnH':'Mn',
                    'FeH':'Fe',
                    'CoH':'Co',
                    'NiH':'Ni',
                    'CuH':'Cu',
                    'ZnH':'Zn',
                    'SrH':'Sr',
                    'SrIIH':'SrII',
                    'YH':'Y',
                    'YIIH':'YII',
                    'ZrH':'Zr',
                    'ZrIIH':'ZrII',
                    'NbIIH':'NbII',
                    'MoH':'Mo',
                    'RuH':'Ru',
                    'PdH':'Pd',
                    'AgH':'Ag',
                    'BaIIH':'BaII',
                    'LaH':'La',
                    'LaIIH':'LaII',
                    'CeH':'Ce',
                    'CeIIH':'CeII',
                    'PrH':'Pr',
                    'PrIIH':'PrII',
                    'NdH':'Nd',
                    'SmH':'Sm',
                    'SmIIH':'SmII',
                    'EuH':'Eu',
                    'EuIIH':'EuII',
                    'GdH':'Gd',
                    'GdIIH':'GdII',
                    'TbIIH':'TbII',
                    'DyH':'Dy',
                    'DyIIH':'DyII',
                    'ErIIH':'ErII',
                    'TmIIH':'TmII',
                    'YbIIH':'YbII',
                    'HfH':'Hf',
                    'HfIIH':'HfIIH',
                    'PbH': 'Pb',
                    'ThIIH':'ThII'
                };
                $scope.catalogs = ["Adamow et al. (2014)", "Adibekyan et al. (2012)", "Adibekyan et al. (2015)", "Allen & Porto de Mello (2011)", "Allende Prieto et al. (2004)", "Battistini et al. 2015", "Bensby et al. (2005)", "Bensby et al. 2014", "Bergemann et al. (2010)", "Bertran de Lis et al. (2015)", "Biazzo et al. (2012)", "Bodaghee et al. (2003)", "Boesgaard et al. (2011)", "Bond et al. (2006, 2008)", "Brewer & Carney (2006)", "Brugamyer et al. (2011)", "Bruntt et al. (2012)", "Caffau et al. (2011)", "Carretta et al. (2000)", "Castro et al. (1997)", "Castro et al. (1999)", "Chen et al. (2000)", "D'Orazi et al. (2012)", "da Silva et al. (2012)", "Delgado Mena et al. (2010)", "Ecuvillon et al. (2004)", "Ecuvillon et al. (2006)", "Edvardsson et al. (1993)", "Feltzing & Gustafsson (1998)", "Feltzing et al. (2007)", "Francois (1986)", "Francois (1988)", "Fulbright (2000)", "Galeev et al. (2004)", "Gebran et al. (2010)", "Gehren et al. (2004)", "Gehren et al. (2006)", "Gilli et al. (2006)", "Gonzalez & Laws (2007)", "Gonzalez et al. (2001)", "Gonzalez Hernandez et al. (2010)", "Gonzalez Hernandez et al. (2013)", "Gratton et al. (2000)", "Gratton et al. (2003)", "Gustafsson et al. (1999)", "Huang et al. (2005)", "Ishigaki et al. (2012)", "Ishigaki et al. (2013)", "Jofre et al. (2015)", "Jonsell et al. (2005)", "Kang et al. (2011)", "Karinkuzhi et al. (2014)", "Koch & Edvardsson (2002)", "Korotin et al. (2011)", "Laird (1985)", "Liu et al. (2012)", "Luck & Heiter (2005)", "Maldonado et al. (2013)", "Mann et al. 2013", "Mashonkina et al. (2006)", "Mashonkina et al. (2007)", "Mishenina et al. (2003)", "Mishenina et al. (2004)", "Mishenina et al. (2008)", "Mishenina et al. (2011)", "Mishenina et al. (2013)", "Mishenina et al. (2015)", "Mortier et al. (2013)", "Neuforge-Verheecke & Magain (1997)", "Neves et al. (2009)", "Nissen & Schuster (1997)", "Nissen & Schuster (2010)", "Nissen et al. (2011)", "Nissen et al. (2014)", "Nissen et al. (2015)", "Peterson et al. (2013)", "Petigura & Marcy (2011)", "Porto de Mello et al. (2008)", "Ramirez et al. (2007)", "Ramirez et al. (2009)", "Ramirez et al. (2012)", "Ramirez et al. (2014a)", "Ramirez et al. (2014b)", "Recio Blanco et al. (2012)", "Reddy et al. (2003)", "Reddy et al. (2006)", "Sadakane et al. (2002)", "Schuler et al. (2011)", "Shi et al. (2004)", "Shi et al. (2012)", "Sitnova et al. (2015)", "Stonkute et al. (2012)", "Stonkute et al. (2013)", "Takeda (2007), Takeda & Honda (2005)", "Takeda et al. (2005)", "Thevenin (1998)", "Trevisan et al. (2011)", "Valenti & Fischer (2005)", "Wang et al. (2011)", "Wu et al. (2015)", "Yan et al. (2015)", "Zenovience et al. (2014)", "Zhang & Zhao (2006)", "Zhao et al. (2002)"];
                $scope.stars = {};
                $scope.noPlanets = false; // flag to indicate whether to retrieve planet info
                $scope.showElements = false;
                $scope.solarnorm = 'Lodders et al. (2009)';
                $scope.agg = 'median';
                $scope.activeChart = 1;
                $scope.xaxis_num = 'FeH';
                $scope.yaxis_num = 'SiH';
                $scope.xaxis_den = 'H';
                $scope.yaxis_den = 'H';
                $scope.c2_xaxis = 'dist';
                $scope.c2_yaxis = 'uwsq';
                $scope.c3_xaxis = 'e';
                $scope.c3_yaxis = 'sma';
                $scope.c4_xaxis_num = 'MgH';
                $scope.c4_xaxis_den = 'SiH';
                $scope.c4_yaxis = 'rfreq';
                $scope.zaxis_num = 'CH';
                $scope.zaxis_den = 'OH';
                $scope.renderTable = false;

                // TODO: Update URL to make it sharable
                // $location.search({"search": "hip>100"});

                $scope.parseFloat = parseFloat;
                let pageNumber = 0, pageSize = 25;

                function fetchStars() {
                    let deferred = $q.defer();
                    StarService.stars(pageNumber, pageSize, $scope.filterText).then(function (data) {
                        if (Object.keys(data['stars']).length < pageSize)
                            deferred.reject(); // fetched all stars
                        angular.extend($scope.stars, data['stars']);
                        setAlertMsg(data, $scope, 'success');
                        $scope.updateZ();
                        if ($scope.showElements)
                            fetchElements();
                        fetchPlanets();
                        deferred.resolve();
                    }, function (err) {
                        setAlertMsg(err, $scope, 'danger');
                        deferred.reject();
                    });
                    return deferred.promise;
                }

                $scope.cStars = function () {
                    return Object.keys($scope.stars).length;
                };

                $scope.filterStars = function (e) {
                    e.preventDefault();
                    return invokeFilters();
                };
                function initPage() {
                    fetchStars().then(function () {
                        pageNumber++;
                        // Keep loading more stars until the user's screen is full
                        if ($(document).height() < $(window).height())
                            initPage();
                    });

                }

                initPage();

                $(window).scroll(function () {
                    // Pre-fetch the stars before user hits the bottom to get a smooth user experience
                    // 120 is arrived assuming user takes 0.5s to scroll one a screen of 1000px long and
                    // network i/o = 60ms,
                    if ($(window).scrollTop() == $(document).height() - $(window).height()) {
                        pageNumber++;
                        fetchStars();
                    }
                });

                /**
                 * Finds the min and max values in a list of objects
                 * param: objects => list of JS objects. Eg. [{name: 'A', age: 10}, {name: ...}...]
                 * param: objectKey => comparison key for each object. Eg. age
                 * return: Min and max values of all objects. Eg. Min age and max age in all objects given
                 */
                function minMaxForRange(objects, objectKey) {
                    var min = Infinity, max = -Infinity;
                    for (let obj of objects) {
                        try {
                            let val = obj[objectKey];
                            if (val < min) {
                                min = val;
                            }
                            if (val > max) {
                                max = val;
                            }
                        }
                        catch (err) {
                        }
                    }
                    return [min, max];
                }

                /**
                 * Returns a color from a palette based on number of bins
                 * Using the min and max values passed, the function divides the range into equal sized bins
                 * Each of the bins is assigned a color
                 * Then for the value, val, passed a color in HEX is returned depending in which bin the value lies
                 * This is used for deciding the colors of bullets in the plots
                 */
                function bulletColor(val, min, max) {
                    const bins = 3;
                    const colors = ["#cc0000", "#00cc00", "#5555cc"];
                    let interval = (max - min) / bins * 1.0;
                    let tick1 = min + interval;
                    let tick2 = tick1 + interval;
                    if (val <= tick1)
                        return colors[0];
                    if (val > tick2)
                        return colors[2];
                    return colors[1];
                }

                /**
                 * Updates the coloring or the 3rd dimension of the chart
                 * For every star based on its X/Y under Z-axis, its bullet is assigned to be used later
                 */
                function computeZ() {
                    let deferred = $q.defer();
                    var hips = Object.keys($scope.stars);
                    PlotService.scatter($scope.solarnorm, hips,
                            [$scope.zaxis_num, $scope.zaxis_den], $scope.excluded_cat).then(function (data) {
                        /**
                         * Sample data:
                         * stars: {
                                    7444: {
                                        AlH: {mdn: -0.029, avg: -0.03},
                                        CaH: {mdn: 0.01, avg: 0.03},
                                        FeH: {mdn: -0.5, avg: -0.43}
                                    },
                               }
                         */

                        let points = [], starComposition = data['stars'];
                        for (let star in starComposition) {
                            let composition = starComposition[star];
                            try {
                                let z = $scope.agg === 'mean' ? getPlotValue(composition, ['zaxis_num', 'zaxis_den'], 'avg') : getPlotValue(composition, ['zaxis_num', 'zaxis_den'], 'mdn');
                                points.push({
                                    "z": z,
                                    "star": star
                                });
                            }
                            catch (err) {
                                console.log(`For star, ${star}. Error: ${err}`);
                            }
                        }

                        let min = 0, max = 0;
                        [min, max] = minMaxForRange(points, 'z');
                        for (let p of points) {
                            $scope.stars[p['star']]['color'] = bulletColor(p['z'], min, max);
                        }
                        deferred.resolve();
                    }, function (err) {
                        deferred.reject();
                    });
                    return deferred.promise;
                }

                $scope.updateZ = function () {
                    computeZ().then(function () {
                        $scope.updateChart();
                    }, function () {
                        console.warn('Computing Z axis failed');
                    });
                };

                /**
                 * Renders X/Y VS X/Y chart using the starComposition which has element information
                 */
                $scope.renderChart1 = function (starComposition) {
                    let xlabel = `[${$scope.elements[$scope.xaxis_num]}/${$scope.elements[$scope.xaxis_den]}]`;
                    let ylabel = `[${$scope.elements[$scope.yaxis_num]}/${$scope.elements[$scope.yaxis_den]}]`;

                    let points = [];
                    for (let star in starComposition) {
                        let composition = starComposition[star];
                        try {
                            let x = $scope.agg === 'mean' ? getPlotValue(composition, ['xaxis_num', 'xaxis_den'], 'avg') : getPlotValue(composition, ['xaxis_num', 'xaxis_den'], 'mdn');
                            let y = $scope.agg === 'mean' ? getPlotValue(composition, ['yaxis_num', 'yaxis_den'], 'avg') : getPlotValue(composition, ['yaxis_num', 'yaxis_den'], 'mdn');
                            points.push({
                                x: x,
                                y: y,
                                value: `Star: ${star}<br />${xlabel}: ${x}<br />${ylabel}: ${y}`,
                                color: $scope.stars[star]['color']
                            });
                        }
                        catch (err) {
                            console.log(`For star, ${star}. Error: ${err}`);
                        }
                    }

                    $scope.chart.dataProvider = points;
                    $scope.chart.valueAxes[0].title = xlabel;
                    $scope.chart.valueAxes[1].title = ylabel;
                    $scope.chart.validateData();
                };

                $scope.renderChart2 = function () {
                    let axes_labels = {'uwsq': 'SQRT(u^2 + w^2)', 'dist': 'Distance', 'v': 'V'};
                    let xlabel = axes_labels[$scope.c2_xaxis];
                    let ylabel = axes_labels[$scope.c2_yaxis];

                    let points = [];
                    for (let hip in $scope.stars) {
                        let star = $scope.stars[hip];
                        try {
                            let x = star[$scope.c2_xaxis];
                            let y = computeY(star);
                            points.push({
                                x: x,
                                y: y,
                                value: `Star: ${hip}<br />${xlabel}: ${x}<br />${ylabel}: ${y}`,
                                color: $scope.stars[hip]['color']
                            });
                        }
                        catch (err) {
                            console.log(`For star, ${star}. Error: ${err}`);
                        }
                    }

                    $scope.chart.dataProvider = points;
                    $scope.chart.valueAxes[0].title = xlabel;
                    $scope.chart.valueAxes[1].title = ylabel;
                    $scope.chart.validateData();

                    function computeY(star) {
                        switch ($scope.c2_yaxis) {
                            default:
                                // SQRT(u^2 + w^2)
                                return Math.sqrt(star['u'] * star['u'] + star['w'] * star['w']);
                        }
                    }
                };

                $scope.renderChart3 = function () {
                    let axes_labels = {
                        'period': 'Period',
                        'sma': 'Semi Major Axis',
                        'pmass': 'Planetary Mass',
                        'e': 'Eccentricity'
                    };
                    let xlabel = axes_labels[$scope.c3_xaxis];
                    let ylabel = axes_labels[$scope.c3_yaxis];

                    let points = [];
                    for (let hip in $scope.stars) {
                        let star = $scope.stars[hip], x = 0, y = 0;
                        try {
                            if (isStellarProperty($scope.c3_xaxis))
                                x = computeXY(star, "X");
                            if (isStellarProperty($scope.c3_yaxis))
                                y = computeXY(star, "Y");

                            for (let planet of star['planets']) {
                                x = isStellarProperty($scope.c3_xaxis) ? x : computeXY(planet, "X");
                                y = isStellarProperty($scope.c3_yaxis) ? y : computeXY(planet, "Y");
                                points.push({
                                    x: x,
                                    y: y,
                                    value: `${hip} [${planet['name']}]<br />${xlabel}: ${x}<br />${ylabel}: ${y}`,
                                    color: $scope.stars[hip]['color']
                                });
                            }
                        }
                        catch (err) {
                            console.log(`For star, ${star}. Error: ${err}`);
                        }
                    }

                    $scope.chart.dataProvider = points;
                    $scope.chart.valueAxes[0].title = xlabel;
                    $scope.chart.valueAxes[1].title = ylabel;
                    $scope.chart.validateData();

                    /*
                     Returns true if given property is stellar
                     */
                    function isStellarProperty(property) {
                        return ['smass'].indexOf(property) >= 0;
                    }

                    function computeXY(obj, axis) {
                        // obj can be instance of a star or a planet
                        let attr = axis === 'X' ? $scope.c3_xaxis : $scope.c3_yaxis;
                        switch (attr) {
                            case 'pmass':
                                return parseFloat(obj['m_p']);
                            case 'period':
                                return parseFloat(obj['p']);
                            case 'sma':
                                return parseFloat(obj['a']);
                            case 'smass':
                                return parseFloat(obj['mass']);
                            default:
                                return parseFloat(obj[attr]);
                        }
                    }
                };

                $scope.renderChart4 = function (starComposition) {
                    const axes_labels = {'rfreq': 'Relative Frequency'};
                    let xlabel = `[${$scope.elements[$scope.c4_xaxis_num]}/${$scope.elements[$scope.c4_xaxis_den]}]`;
                    let ylabel = axes_labels[$scope.c4_yaxis];

                    let stars_composition = [];
                    for (let star in starComposition) {
                        let composition = starComposition[star];
                        stars_composition.push({'k': $scope.agg === 'mean' ? getPlotValue(composition, ['c4_xaxis_num', 'c4_xaxis_den'], 'avg') : getPlotValue(composition, ['c4_xaxis_num', 'c4_xaxis_den'], 'mdn')});
                    }

                    var min = 0, max = 0;
                    [min, max] = minMaxForRange(stars_composition, 'k');
                    const BIN_SIZE = 0.1;
                    let bins = Math.ceil((max - min) / BIN_SIZE);
                    let counts = new Array(bins).fill(0); // ES6 only
                    for (let star in stars_composition) {
                        let composition = stars_composition[star]['k'];
                        counts[Math.floor((composition - min) / BIN_SIZE)] += 1;
                    }

                    let points = [];
                    for (let x = min, i = 0; x <= max + BIN_SIZE; x += BIN_SIZE, i++) {
                        try {
                            let y = counts[i];
                            points.push({
                                "x": x,
                                "y": y,
                                "value": `${xlabel}: ${x}<br />${ylabel}: ${y}`
                            });
                        }
                        catch (err) {
                            console.log(`Error: ${err}`);
                        }
                    }

                    $scope.chart.dataProvider = points;
                    $scope.chart.valueAxes[0].title = xlabel;
                    $scope.chart.valueAxes[1].title = ylabel;
                    $scope.chart.validateData();
                };

                $scope.renderChart5 = function () {
                    $scope.chart.dataProvider = [];
                    $scope.chart.valueAxes[0].title = "";
                    $scope.chart.valueAxes[1].title = "";
                    $scope.chart.validateData();
                };

                /**
                 * Returns the aggregated value for the complex element from simple elements
                 * Using Fe/H and Si/H, compute the value for Fe/Si and return
                 * :param: axis: is an array having 2 elements. First is key for x-axis and second, key for y-axis
                 */
                function getPlotValue(composition, axis, aggregation) {
                    let op1 = composition[$scope[axis[0]]][aggregation];
                    let op2 = $scope[axis[1]] !== 'H' ? composition[$scope[axis[1]]][aggregation] : 0;
                    return op1 - op2;
                }

                $scope.updateChart = function () {
                    /*if ($scope.activeChart === 4) {
                     $scope.chart.graphs = [columnGraph];
                     }
                     else {
                     $scope.chart.graphs = [xyGraph];
                     }*/
                    switch ($scope.activeChart) {
                        case 1:
                            var hips = Object.keys($scope.stars);
                            PlotService.scatter($scope.solarnorm, hips,
                                    [$scope.xaxis_num, $scope.yaxis_num, $scope.xaxis_den, $scope.yaxis_den], $scope.excluded_cat).then(function (data) {
                                /**
                                 * Sample data:
                                 * stars: {
                                    7444: {
                                        AlH: {mdn: -0.029, avg: -0.03},
                                        CaH: {mdn: 0.01, avg: 0.03},
                                        FeH: {mdn: -0.5, avg: -0.43}
                                    },
                               }
                                 */
                                $scope.renderChart1(data['stars']);
                            });
                            break;
                        case 2:
                            $scope.renderChart2();
                            break;
                        case 3:
                            $scope.renderChart3();
                            break;
                        case 4:
                            hips = Object.keys($scope.stars);
                            PlotService.scatter($scope.solarnorm, hips,
                                    [$scope.c4_xaxis_num, $scope.c4_xaxis_den], $scope.excluded_cat).then(function (data) {
                                /**
                                 * Sample data:
                                 * stars: {
                                    7444: {
                                        AlH: {mdn: -0.029, avg: -0.03},
                                        CaH: {mdn: 0.01, avg: 0.03},
                                        FeH: {mdn: -0.5, avg: -0.43}
                                    },
                               }
                                 */
                                $scope.renderChart4(data['stars']);
                            });
                            break;
                        case 5:
                            $scope.renderChart5();
                            break;
                    }
                };

                function fetchPlanetProps() {
                    let hips = Object.keys($scope.stars);
                    PlanetService.planet_props(hips).then(function (data) {
                        /**
                         * Sample data:
                         * {hip1 [planet1]: {m_p: 867, p: 0.889}, hip2 [planet2]: {m_p: 773, p: 0.8772}}
                         */
                        $scope.star_planet = data['planets'];
                    });
                }

                function fetchPlanets() {
                    let hips = Object.keys($scope.stars);
                    PlanetService.planets(hips).then(function (data) {
                        /**
                         * Sample data:
                         * {
                         *      hip1: [{planet1_obj}, {planet2_obj}, {planet3_obj},...]
                         *      hip2: [{planet1_obj}, {planet2_obj}, {planet3_obj},...]
                         * }
                         */
                        for (let hip in data['planets']) {
                            $scope.stars[hip]['planets'] = data['planets'][hip];
                        }
                    });
                }

                function fetchElements() {
                    let hips = Object.keys($scope.stars);
                    StarService.elements(hips).then(function (data) {
                        /**
                         * Sample data:
                         * {
                         *      hip1: [{elem1_obj}, {elem2_obj}, {elem3_obj},...]
                         *      hip2: [{elem1_obj}, {elem2_obj}, {elem3_obj},...]
                         * }
                         */
                        for (let hip in data['elements']) {
                            $scope.stars[hip]['elements'] = data['elements'][hip];
                        }
                    });
                }

                // Filters
                $scope.onlyPlanets = function () {
                    $scope.noPlanets = false;
                    $scope.filterText = 'multiple_planets > 0';
                    invokeFilters();
                };
                $scope.exceptPlanets = function () {
                    $scope.noPlanets = true;
                    $scope.filterText = 'multiple_planets = 0';
                    invokeFilters();
                };
                $scope.regardlessOfPlanets = function () {
                    $scope.noPlanets = false;
                    $scope.filterText = '';
                    invokeFilters();
                };
                $scope.toggleElements = function () {
                    if ($scope.showElements) {
                        fetchElements();
                    }
                };
                function invokeFilters() {
                    pageNumber = 0; // reset page
                    $scope.stars = {}; // clear stars to make way for new set
                    fetchStars().then(function () {
                        $scope.updateChart();
                    });
                }

                // Charting
                const columnGraph = {
                    "type": "column",
                    "valueField": "y"
                };
                const xyGraph = {
                    "bullet": "round",
                    "bulletAlpha": 0,
                    "bulletBorderAlpha": 1,
                    "bulletBorderColorField": "color",
                    "colorField": "color",
                    "bulletSize": 10,
                    "lineAlpha": 0,
                    "valueField": "value",
                    "xField": "x",
                    "yField": "y"
                };
                const chartProperties = {
                    "type": "xy",
                    "autoMargins": true,
                    "autoMarginOffset": 20,
                    "handDrawn": false,
                    "addClassNames": false,
                    "graphs": [xyGraph],
                    'valueAxes': [{
                        "position": "bottom",
                        "axisAlpha": 0,
                        "dashLength": 1
                    }, {
                        "axisAlpha": 0,
                        "dashLength": 1,
                        "position": "left"
                    }],
                    "categoryField": 'x',
                    "dataProvider": [],
                    "export": {
                        "enabled": true
                    },
                    legend: {
                        position: "right",
                        align: "center",
                        markerType: "round",
                        valueText: "aa",
                        data: [{title: "Low", color: "#cc0000"}, {title: "Medium", color: "#00cc00"}, {
                            title: "High",
                            color: "#5555cc"
                        }, {title: "NA", color: "#FF6600"}],
                        divId: "legend"
                    }
                };
                $scope.chart = AmCharts.makeChart("chart", chartProperties);

            });

            app.directive('myAlert', function () {
                return {
                    restrict: 'E',
                    scope: {
                        msg: '=',
                        type: '='
                    },
                    templateUrl: '/partials/_my-alert.html'
                }
            });

            app.factory('StarService', function ($http, $q) {
                return {
                    "stars": function (pageNumber, pageSize, query=null) {
                        let deferred = $q.defer();
                        $http.get(`/stars/${pageNumber}/${pageSize}`, {params: {'query': query}}).success(function (data) {
                            deferred.resolve(data);
                        }).error(function (err) {
                            deferred.reject(err);
                        });
                        return deferred.promise;
                    },
                    "elements": function (stars=[]) {
                        let deferred = $q.defer();
                        $http.post('/elements/', {stars: stars}).success(function (data) {
                            deferred.resolve(data);
                        }).error(function (err) {
                            deferred.reject(err);
                        });
                        return deferred.promise;
                    }
                }
            });

            app.factory('PlanetService', function ($http, $q) {
                return {
                    "planets": function (stars=[]) {
                        let deferred = $q.defer();
                        $http.post('/planets/', {stars: stars}).success(function (data) {
                            deferred.resolve(data);
                        }).error(function (err) {
                            deferred.reject(err);
                        });
                        return deferred.promise;
                    },
                    "planet_props": function (stars=[], properties=['name', 'mass', 'e']) {
                        let deferred = $q.defer();
                        $http.post('/planet-props/', {
                            stars: stars,
                            properties: properties
                        }).success(function (data) {
                            deferred.resolve(data);
                        }).error(function (err) {
                            deferred.reject(err);
                        });
                        return deferred.promise;
                    }
                }
            });

            app.factory('PlotService', function ($http, $q) {
                return {
                    "scatter": function (solarnorm, stars=[], elements=[], catalogs=[]) {
                        let deferred = $q.defer();
                        let data = {
                            'normalization': solarnorm,
                            'stars': stars,
                            'elements': elements,
                            'catalogs': catalogs
                        };
                        $http.post(`/plots/composition/`, data).success(function (data) {
                            deferred.resolve(data);
                        }).error(function (err) {
                            deferred.reject(err);
                        });
                        return deferred.promise;
                    }
                }
            });

            // JQuery
            $("#search").popover();
            $('[data-toggle="tooltip"]').tooltip();


        })(window.angular, window.$, window.AmCharts);
    </script>
{% endblock %}