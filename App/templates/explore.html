{% extends "index.html" %}
{% block title %}Explore & Interact with Data{% endblock %}

{% block head %}
{{ super() }}
<link href="/static/bower_components/jquery-ui/themes/smoothness/jquery-ui.min.css" rel="stylesheet"/>
<style type="text/css">
    .popover {
        max-width: 100%;
    }
</style>
{% endblock %}

{% block content %}
{% raw %}
<div ng-app="viz">
    <div ng-cloak ng-controller="VisualizationController as v">

        <my-alert data-msg="alert_msg" data-type="alert_type"></my-alert>

        <form style="margin-bottom: 10px;">
            <input style="width: 83.333333%" type="text" class="form-control col-md-10 col-xs-10 col-sm-10" id="search"
                   placeholder="Filter criteria" ng-focus="openSuggestions()"
                   data-toggle="popover" data-placement="top" data-container="body" data-trigger="hover focus"
                   data-html="true" title="Need help? Readme"
                   data-content="you can try any of these,<ul><li>hip = 7444</li><li>dist > 20 and disk = thin</li><li>rascension > 300 or declination < 50</li></ul>">
            <button type="submit" style="margin-left: 10px;" class="btn btn-primary col-md-1 col-xs-1 col-sm-1">Filter
            </button>
            <div class="clearfix"></div>
        </form>

        <div class="table-responsive">
            <table class="table table-condensed table-bordered table-striped">
                <thead>
                <tr>
                    <th ng-repeat="c in columns">{{c}}</th>
                </tr>
                </thead>
                <tr ng-repeat="star in stars track by star.hip">
                    <td ng-repeat="c in columns">{{ star[c] }}</td>
                </tr>
            </table>
        </div>
    </div>
</div>
{% endraw %}
<script type="text/javascript" src="/static/bower_components/angular/angular.min.js"></script>
<script type="text/javascript" src="/static/bower_components/angular-sanitize/angular-sanitize.min.js"></script>
<script type="text/javascript" src="/static/bower_components/jquery/dist/jquery.min.js"></script>
<script type="text/javascript" src="/static/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/static/bower_components/jquery-ui/ui/core.js"></script>
<script type="text/javascript" src="/static/bower_components/jquery-ui/ui/widget.js"></script>
<script type="text/javascript" src="/static/bower_components/jquery-ui/ui/position.js"></script>
<script type="text/javascript" src="/static/bower_components/jquery-ui/ui/menu.js"></script>
<script type="text/javascript" src="/static/bower_components/jquery-ui/ui/autocomplete.js"></script>

<script type="text/javascript" src="/static/js/StateMachine.js"></script>

<script type="text/javascript">
    (function (angular, $) {
        const app = angular.module('viz', ['ngSanitize']);

        function setAlertMsg(data, $scope, type='info') {
            if (data['status']) {
                $scope.alert_type = type;
                $scope.alert_msg = data['status']['message'];
            }
        }

        app.controller('VisualizationController', function ($scope, StarService) {
            $scope.columns = ['hip', 'hd', 'hr', 'spec', 'vmag', 'bv', 'dist', 'rascension', 'declination', 'position', 'disk', 'uvw'];
            StarService.stars().then(function (data) {
                $scope.stars = data['stars'];
                setAlertMsg(data, $scope, 'success');
            }, function (err) {
                setAlertMsg(err, $scope, 'danger');
            });


            let start = new State($scope.columns);
            let filterExpr = new StateMachine(start); // key
            filterExpr.next(new State(['>', '<', '=', '<=', '>='])); // operator
            filterExpr.next(new State([], true)); // values
            filterExpr.next(new State(['AND', 'OR'])); // combiner
            filterExpr.next(start);
            window.myState = filterExpr;
            let filterTokens = [], states = [];

            function suggest(request, response) {
                console.log(filterExpr.current.values);
                response(filterExpr.current.values);
            }

            function moveToNextState(newItem) {
                filterTokens.push(newItem);
                this.value = filterTokens.join(" ") + " ";
                states.push(filterExpr.current); // TODO: handle when user starting modifying existing expression
                filterExpr.next(); // move to next state
                $scope.openSuggestions();
            }

            function getTokens(filterText) {
                // tokens are separated by a space
                return filterText.split(/\s+/);
            }

            function selected(event, ui) {
                moveToNextState.call(this, ui.item.value.trim());
                return false; // prevent default behavior of replacing the entire input field's value
            }

            $scope.openSuggestions = function () {
                $("#search").autocomplete("search"); // open suggestions
            };
            $("#search").bind('keypress', function (event) {
                if (event.keyCode === $.ui.keyCode.SPACE) {
                    // Move to next state
                    moveToNextState.call(this, getTokens(this.value.trim()).pop());
                    event.preventDefault();
                }
            }).autocomplete({
                source: suggest,
                select: selected, minLength: 0,
                focus: function () {
                    return false;
                }
            });
        });

        app.directive('myAlert', function () {
            return {
                restrict: 'E',
                scope: {
                    msg: '=',
                    type: '='
                },
                templateUrl: '/partials/_my-alert.html'
            }
        });

        app.factory('StarService', function ($http, $q) {
            return {
                "stars": function () {
                    let deferred = $q.defer();
                    $http.get('/stars/0/10').success(function (data) {
                        deferred.resolve(data);
                    }).error(function (err) {
                        deferred.reject(err);
                    });
                    return deferred.promise;
                }
            }
        });

        // JQuery
        $("#search").popover();


    })(window.angular, window.$);
</script>
{% endblock %}